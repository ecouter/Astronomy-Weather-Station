import { VerticalBox, Button, HorizontalBox } from "std-widgets.slint";
import { IconButton } from "../../material-1.0/ui/components/icon_button.slint";
import { SegmentedButton } from "../../material-1.0/ui/components/segmented_button.slint";
import { Icons } from "../../material-1.0/ui/icons/icons.slint";

export component AuroraPage inherits Rectangle {
    background: #1c1c1c;
    height: 100%;
    width: 100%;
    in property <image> aurora_forecast_image;
    in property <image> ace_solar_wind_image;
    in property <image> dscovr_solar_wind_image;
    in property <image> space_weather_overview_image;
    in property <image> ace_epam_image;
    in property <image> canadian_magnetic_image;
    in property <image> alerts_timeline_image;
    in property <image> all_sky_image;
    in property <string> all_sky_location_name;
    in property <[image]> all_sky_images;
    in-out property <int> current_section: 0;
    in-out property <bool> show_zoomed_image: false;
    in-out property <image> zoomed_image;
    in-out property <string> zoomed_title;
    property <float> zoom-factor: 3.0;
    property <length> loupe-radius: 50px;
    in property <string> refresh_button_text: "Refresh";
    in property <bool> refresh_button_enabled: true;
    in property <bool> aurora_forecast_error: false;
    in property <bool> space_weather_overview_error: false;
    in property <bool> alerts_timeline_error: false;
    in property <bool> ace_solar_wind_error: false;
    in property <bool> dscovr_solar_wind_error: false;
    in property <bool> ace_epam_error: false;
    in property <bool> canadian_magnetic_error: false;
    in property <image> tonights_forecast_image;
    in property <bool> tonights_forecast_error: false;
    in property <image> tomorrow_forecast_image;
    in property <bool> tomorrow_forecast_error: false;
    in property <image> wsa_enlil_image;
    in property <bool> wsa_enlil_error: false;
    in property <image> nasa_viirs_image;
    in property <bool> nasa_viirs_error: false;
    in property <[bool]> all_sky_errors: [];
    callback go_back();
    callback all_sky_previous();
    callback all_sky_next();
    callback refresh_aurora();

    VerticalLayout {
        padding-left: 25px;
        padding-right: 35px;
        padding-top: 20px;
        padding-bottom: 20px;
        spacing: 10px;

        // Back button, title, and refresh button
        HorizontalLayout {
            alignment: center;
            height: 40px;
            spacing: 50px;
            Button {
                width: 200px;
                text: "Back";
                clicked => { go_back(); }
            }
            Text {
                text: "Aurora & Space Weather Dashboard";
                font-size: 36px;
                color: #ffffff;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
            Rectangle { // spacer
                horizontal-stretch: 1;
                background: transparent;
            }
            Button {
                width: 200px;
                text: refresh_button_text;
                enabled: refresh_button_enabled;
                clicked => { refresh_aurora(); }
            }
        }

        // Segmented button for section navigation
        SegmentedButton {
            current-index: current_section;
            height: 50px;
            items: [
                { text: "Dashboard" },
                { text: "All Sky Cam" },
                { text: "Advanced Space Weather" },
                { text: "Predictions" }
            ];
            index-changed(index) => {
                current_section = index;
            }
        }

        // Section 0: Dashboard (Aurora forecast, Space weather overview, Alerts timeline)
        if current_section == 0: VerticalLayout {
            spacing: 20px;

            HorizontalLayout {
                spacing: 20px;

                // Aurora forecast
                VerticalLayout {
                    spacing: 10px;
                    width: root.width * 0.390625;

                    Text {
                        text: "Aurora Forecast - Northern Hemisphere";
                        color: #ffffff;
                        height: 30px;
                        font-size: 18px;
                        font-weight: 600;
                        horizontal-alignment: center;
                    }

                    TouchArea {
                        Image {
                            source: aurora_forecast_image;
                            width: 100%;
                            height: 100%;
                            image-fit: contain;
                        }
                        clicked => {
                            if (!aurora_forecast_error) {
                                zoomed_image = aurora_forecast_image;
                                zoomed_title = "Aurora Forecast - Northern Hemisphere";
                                show_zoomed_image = true;
                            }
                        }
                    }

                    // Error overlay
                    if (aurora_forecast_error): Rectangle {
                        width: root.width * 0.3125;
                        height: 300px;
                        background: #000000;
                        z: 10;

                        Text {
                            text: "IMAGE UNAVAILABLE";
                            color: #ffffff;
                            font-size: 24px;
                            font-weight: 700;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }

                // Space weather overview
                VerticalLayout {
                    spacing: 10px;
                    width: root.width * 0.2734375;

                    Text {
                        text: "Space Weather Overview";
                        color: #ffffff;
                        height: 30px;
                        font-size: 18px;
                        font-weight: 600;
                        horizontal-alignment: center;
                    }

                    TouchArea {
                        Image {
                            source: space_weather_overview_image;
                            width: 100%;
                            height: 100%;
                            image-fit: contain;
                        }
                        clicked => {
                            if (!space_weather_overview_error) {
                                zoomed_image = space_weather_overview_image;
                                zoomed_title = "Space Weather Overview";
                                show_zoomed_image = true;
                            }
                        }
                    }

                    // Error overlay
                    if (space_weather_overview_error): Rectangle {
                        width: root.width * 0.3125;
                        height: 300px;
                        background: #000000;
                        z: 10;

                        Text {
                            text: "IMAGE UNAVAILABLE";
                            color: #ffffff;
                            font-size: 24px;
                            font-weight: 700;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }

                // Alerts timeline
                VerticalLayout {
                    spacing: 10px;
                    width: root.width * 0.3125;

                    Text {
                        text: "Space Weather Alerts Timeline";
                        color: #ffffff;
                        height: 30px;
                        font-size: 18px;
                        font-weight: 600;
                        horizontal-alignment: center;
                    }

                    TouchArea {
                        Image {
                            source: alerts_timeline_image;
                            width: 100%;
                            height: 100%;
                            image-fit: contain;
                        }
                        clicked => {
                            if (!alerts_timeline_error) {
                                zoomed_image = alerts_timeline_image;
                                zoomed_title = "Space Weather Alerts Timeline";
                                show_zoomed_image = true;
                            }
                        }
                    }

                    // Error overlay
                    if (alerts_timeline_error): Rectangle {
                        width: root.width * 0.3125;
                        height: 300px;
                        background: #000000;
                        z: 10;

                        Text {
                            text: "IMAGE UNAVAILABLE";
                            color: #ffffff;
                            font-size: 24px;
                            font-weight: 700;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }

        // Section 1: All Sky Cam (Show all 10 all-sky cameras)
        if current_section == 1: VerticalLayout {
            spacing: 15px;

            Text {
                text: "Aurora All-Sky Cameras - All Locations";
                color: #ffffff;
                font-size: 24px;
                font-weight: 600;
                horizontal-alignment: center;
            }

            // Grid layout for all 10 all-sky images (2 rows of 5)
            VerticalLayout {
                spacing: 10px;

                // Row 1
                HorizontalLayout {
                    spacing: 10px;
                    for i in 5: VerticalLayout {
                        spacing: 5px;
                        width: root.width * 0.1875;

                        Text {
                            text: [
                                "Kjell Henriksen Observatory, Norway",
                                "Hankasalmi, Finland",
                                "Yellowknife, Canada",
                                "Athabasca, Canada",
                                "Glacier National Park, USA"
                            ][i];
                            color: #ffffff;
                            font-size: 12px;
                            font-weight: 500;
                            horizontal-alignment: center;
                        }

                        TouchArea {
                            width: root.width * 0.1875;
                            height: 180px;
                            Image {
                                source: all_sky_images.length > i ? all_sky_images[i] : @image-url("");
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            clicked => {
                                if all_sky_images.length > i && all_sky_errors.length > i && !all_sky_errors[i] {
                                    zoomed_image = all_sky_images[i];
                                    zoomed_title = "Aurora All-Sky: " + [
                                        "Kjell Henriksen Observatory, Norway",
                                        "Hankasalmi, Finland",
                                        "Yellowknife, Canada",
                                        "Athabasca, Canada",
                                        "Glacier National Park, USA"
                                    ][i];
                                    show_zoomed_image = true;
                                }
                            }
                        }

                        // Error overlay
                        if (all_sky_errors.length > i && all_sky_errors[i]): Rectangle {
                            width: root.width * 0.1875;
                            height: 180px;
                            background: #000000;
                            z: 10;

                            Text {
                                text: "IMAGE UNAVAILABLE";
                                color: #ffffff;
                                font-size: 16px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                }

                // Row 2
                HorizontalLayout {
                    spacing: 10px;
                    for i in 5: VerticalLayout {
                        spacing: 5px;
                        width: root.width * 0.1875;

                        Text {
                            text: [
                                "Hansville, USA",
                                "Isle Royale National Park, USA",
                                "Heiligenblut, Austria",
                                "Calgary, Canada",
                                "Hobart, Australia"
                            ][i];
                            color: #ffffff;
                            font-size: 12px;
                            font-weight: 500;
                            horizontal-alignment: center;
                        }

                        TouchArea {
                            width: root.width * 0.1875;
                            height: 180px;
                            Image {
                                source: all_sky_images.length > (i + 5) ? all_sky_images[i + 5] : @image-url("");
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            clicked => {
                                if all_sky_images.length > (i + 5) && all_sky_errors.length > (i + 5) && !all_sky_errors[i + 5] {
                                    zoomed_image = all_sky_images[i + 5];
                                    zoomed_title = "Aurora All-Sky: " + [
                                        "Hansville, USA",
                                        "Isle Royale National Park, USA",
                                        "Heiligenblut, Austria",
                                        "Calgary, Canada",
                                        "Hobart, Australia"
                                    ][i];
                                    show_zoomed_image = true;
                                }
                            }
                        }

                        // Error overlay
                        if (all_sky_errors.length > (i + 5) && all_sky_errors[i + 5]): Rectangle {
                            width: root.width * 0.1875;
                            height: 180px;
                            background: #000000;
                            z: 10;

                            Text {
                                text: "IMAGE UNAVAILABLE";
                                color: #ffffff;
                                font-size: 16px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
        }

        // Section 2: Advanced Space Weather (ACE solar wind, DSCOVR solar wind, ACE EPAM, Canadian magnetic)
        if current_section == 2: VerticalLayout {
            spacing: 20px;

            VerticalLayout {
                HorizontalLayout {
                    spacing: 20px;
                    height: 50%;

                    // ACE solar wind
                    VerticalLayout {
                        spacing: 10px;
                        width: 400px;

                        Text {
                            text: "ACE Real-Time Solar Wind";
                            height: 30px;
                            color: #ffffff;
                            font-size: 16px;
                            font-weight: 600;
                            horizontal-alignment: center;
                        }

                        TouchArea {
                            Image {
                                source: ace_solar_wind_image;
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            clicked => {
                                if (!ace_solar_wind_error) {
                                    zoomed_image = ace_solar_wind_image;
                                    zoomed_title = "ACE Real-Time Solar Wind";
                                    show_zoomed_image = true;
                                }
                            }
                        }

                        // Error overlay
                        if (ace_solar_wind_error): Rectangle {
                            background: #000000;
                            z: 10;

                            Text {
                                text: "IMAGE UNAVAILABLE";
                                color: #ffffff;
                                font-size: 20px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // NASA VIIRS Nighttime (Top Middle)
                    VerticalLayout {
                        spacing: 10px;
                        width: 400px;

                        Text {
                            text: "NASA VIIRS Nighttime";
                            color: #ffffff;
                            height: 30px;
                            font-size: 16px;
                            font-weight: 600;
                            horizontal-alignment: center;
                        }

                        TouchArea {
                            Image {
                                source: nasa_viirs_image;
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            clicked => {
                                if (!nasa_viirs_error) {
                                    zoomed_image = nasa_viirs_image;
                                    zoomed_title = "NASA VIIRS Nighttime";
                                    show_zoomed_image = true;
                                }
                            }
                        }

                        // Error overlay
                        if (nasa_viirs_error): Rectangle {
                            background: #000000;
                            z: 10;

                            Text {
                                text: "IMAGE UNAVAILABLE";
                                color: #ffffff;
                                font-size: 20px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // DSCOVR solar wind
                    VerticalLayout {
                        spacing: 10px;
                        width: 400px;

                        Text {
                            text: "DSCOVR Solar Wind Data";
                            color: #ffffff;
                            height: 30px;
                            font-size: 16px;
                            font-weight: 600;
                            horizontal-alignment: center;
                        }

                        TouchArea {
                            Image {
                                source: dscovr_solar_wind_image;
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            clicked => {
                                if (!dscovr_solar_wind_error) {
                                    zoomed_image = dscovr_solar_wind_image;
                                    zoomed_title = "DSCOVR Solar Wind Data";
                                    show_zoomed_image = true;
                                }
                            }
                        }

                        // Error overlay
                        if (dscovr_solar_wind_error): Rectangle {
                            background: #000000;
                            z: 10;

                            Text {
                                text: "IMAGE UNAVAILABLE";
                                color: #ffffff;
                                font-size: 20px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
                HorizontalLayout {
                    VerticalLayout {
                        spacing: 10px;
                        width: 420px;
                    
                        Text {
                            text: "ACE EPAM";
                            color: #ffffff;
                            font-size: 16px;
                            font-weight: 600;
                            horizontal-alignment: center;
                            height: 30px;
                        }
                    
                        TouchArea {
                            Image {
                                source: ace_epam_image;
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            clicked => {
                                if (!ace_epam_error) {
                                    zoomed_image = ace_epam_image;
                                    zoomed_title = "ACE EPAM";
                                    show_zoomed_image = true;
                                }
                            }
                        }
                    
                        // Error overlay
                        if (ace_epam_error): Rectangle {
                            width: 300px;
                            height: 250px;
                            background: #000000;
                            z: 10;
                        
                            Text {
                                text: "IMAGE UNAVAILABLE";
                                color: #ffffff;
                                font-size: 20px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                
                    // Canadian magnetic
                    VerticalLayout {
                        spacing: 10px;
                        width: 420px;
                    
                        Text {
                            height: 30px;
                            text: "Canadian Magnetic Observatories";
                            color: #ffffff;
                            font-size: 16px;
                            font-weight: 600;
                            horizontal-alignment: center;
                        }
                    
                        TouchArea {
                            Image {
                                source: canadian_magnetic_image;
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            clicked => {
                                if (!canadian_magnetic_error) {
                                    zoomed_image = canadian_magnetic_image;
                                    zoomed_title = "Canadian Magnetic Observatories";
                                    show_zoomed_image = true;
                                }
                            }
                        }
                    
                        // Error overlay
                        if (canadian_magnetic_error): Rectangle {
                            width: 300px;
                            height: 250px;
                            background: #000000;
                            z: 10;
                        
                            Text {
                                text: "IMAGE UNAVAILABLE";
                                color: #ffffff;
                                font-size: 20px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // WSA-ENLIL Prediction
                    VerticalLayout {
                        spacing: 10px;
                        width: 420px;

                        Text {
                            height: 30px;
                            text: "WSA-ENLIL Prediction";
                            color: #ffffff;
                            font-size: 16px;
                            font-weight: 600;
                            horizontal-alignment: center;
                        }

                        TouchArea {
                            Image {
                                source: wsa_enlil_image;
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            clicked => {
                                if (!wsa_enlil_error) {
                                    zoomed_image = wsa_enlil_image;
                                    zoomed_title = "WSA-ENLIL Prediction";
                                    show_zoomed_image = true;
                                }
                            }
                        }

                        // Error overlay
                        if (wsa_enlil_error): Rectangle {
                            width: 300px;
                            height: 250px;
                            background: #000000;
                            z: 10;

                            Text {
                                text: "IMAGE UNAVAILABLE";
                                color: #ffffff;
                                font-size: 20px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
        }

        // Section 3: Predictions (Tonight's Aurora Forecast, Tomorrow Night's Aurora Forecast)
        if current_section == 3: VerticalLayout {
            spacing: 20px;

            HorizontalLayout {
                spacing: 20px;

                // Tonight's Aurora Forecast
                VerticalLayout {
                    spacing: 10px;
                    width: 600px;

                    Text {
                        text: "Tonight's Aurora Forecast";
                        color: #ffffff;
                        height: 30px;
                        font-size: 18px;
                        font-weight: 600;
                        horizontal-alignment: center;
                    }

                    TouchArea {
                        Image {
                            source: tonights_forecast_image;
                            width: 100%;
                            height: 100%;
                            image-fit: contain;
                        }
                        clicked => {
                            if (!tonights_forecast_error) {
                                zoomed_image = tonights_forecast_image;
                                zoomed_title = "Tonight's Aurora Forecast";
                                show_zoomed_image = true;
                            }
                        }
                    }

                    // Error overlay
                    if (tonights_forecast_error): Rectangle {
                        width: root.width * 0.3125;
                        height: 300px;
                        background: #000000;
                        z: 10;

                        Text {
                            text: "IMAGE UNAVAILABLE";
                            color: #ffffff;
                            font-size: 24px;
                            font-weight: 700;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }

                // Tomorrow Night's Aurora Forecast
                VerticalLayout {
                    spacing: 10px;
                    width: 600px;

                    Text {
                        text: "Tomorrow Night's Aurora Forecast";
                        color: #ffffff;
                        height: 30px;
                        font-size: 18px;
                        font-weight: 600;
                        horizontal-alignment: center;
                    }

                    TouchArea {
                        Image {
                            source: tomorrow_forecast_image;
                            width: 100%;
                            height: 100%;
                            image-fit: contain;
                        }
                        clicked => {
                            if (!tomorrow_forecast_error) {
                                zoomed_image = tomorrow_forecast_image;
                                zoomed_title = "Tomorrow Night's Aurora Forecast";
                                show_zoomed_image = true;
                            }
                        }
                    }

                    // Error overlay
                    if (tomorrow_forecast_error): Rectangle {
                        width: root.width * 0.3125;
                        height: 300px;
                        background: #000000;
                        z: 10;

                        Text {
                            text: "IMAGE UNAVAILABLE";
                            color: #ffffff;
                            font-size: 24px;
                            font-weight: 700;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }

    // Zoom overlay
    if show_zoomed_image: Rectangle {
        background: #000000cc; // Semi-transparent black background
        width: 100%;
        height: 100%;

        VerticalLayout {
            alignment: center;
            spacing: 20px;
            padding-left: 40px;

            HorizontalLayout {
                Text {
                    text: zoomed_title;
                    font-size: 48px;
                    color: #ffffff;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Click image to close";
                    font-size: 24px;
                    vertical-alignment: center;
                    color: #ff0000;
                    horizontal-alignment: center;
                }
            }

            touch_area := TouchArea {
                width: 720px;
                height: 600px;
                Image {
                    source: zoomed_image;
                    width: 100%;
                    height: 100%;
                    image-fit: contain;
                }

                // Loupe overlay (the zoomed part)
                Rectangle {
                    visible: touch_area.has-hover;
                    width: root.loupe-radius * 2;
                    height: root.loupe-radius * 2;
                    x: touch_area.mouse-x - root.loupe-radius;
                    y: touch_area.mouse-y - root.loupe-radius;
                    border-width: 2px;
                    border-color: #888;
                    clip: true;
                    // Make it circular
                    border-radius: root.loupe-radius;
                    z: 100;

                    Image {
                        source: root.zoomed_image;
                        // JavaScript-style background-position calculation: ((x * zoom) - w + bw)
                        // where w = loupe-radius * 2, bw = 2px border
                        x: -((touch_area.mouse-x * root.zoom-factor) - (root.loupe-radius * 2) + root.loupe-radius);
                        y: -((touch_area.mouse-y * root.zoom-factor) - (root.loupe-radius * 2) + root.loupe-radius);
                        // Scale the image for magnification
                        width: touch_area.width * root.zoom-factor;
                        height: touch_area.height * root.zoom-factor;
                    }
                }

                clicked => {
                    show_zoomed_image = false;
                }
            }
        }
    }
}
