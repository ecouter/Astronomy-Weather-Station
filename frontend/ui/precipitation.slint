import { Button, VerticalBox, HorizontalBox } from "std-widgets.slint";
import { IconButton } from "../../material-1.0/ui/components/icon_button.slint";
import { DropDownMenu } from "../../material-1.0/ui/components/drop_down_menu.slint";
import { Slider } from "../../material-1.0/ui/components/slider.slint";
import { MenuItem } from "../../material-1.0/ui/items/menu_item.slint";
import { Icons } from "../../material-1.0/ui/icons/icons.slint";

export component PrecipitationPage inherits Rectangle {
    in property <bool> loading;
    in property <string> error_message;

    in property <image> base_map_image;
    in property <image> active_precip_image;
    in property <image> legend_image;

    in property <bool> active_image_error;

    in property <string> last_update_text;
    in property <string> active_model_label;
    in property <string> active_layer_label;
    in property <string> active_time_label;

    in property <int> selected_mode_index;
    in property <int> selected_model_index;
    in property <int> selected_layer_index;
    in property <int> selected_time_index;
    in property <int> selected_category_index;
    in property <int> selected_sublayer_index;
    in property <int> selected_predictions_model_index;

    in property <[MenuItem]> layer_dropdown_items;
    in property <[MenuItem]> model_dropdown_items;

    // Point data properties (probabilities, amounts, snow depth, etc.)
    in property <int> prob_rain;
    in property <int> prob_snow;
    in property <int> prob_freezing_rain;
    in property <int> prob_ice_pellets;
    in property <int> prob_any_precip;

    in property <float> qpf_6h;
    in property <float> qpf_12h;
    in property <float> qpf_24h;

    in property <float> snow_depth;
    in property <float> air_temp;
    in property <float> dewpoint;
    in property <float> pressure;

    in property <string> system_summary;

    in property <float> time_slider_value;
    in property <float> time_slider_min;
    in property <float> time_slider_max;

    // Callbacks to Rust
    callback go_back();
    callback model_changed(int);
    callback layer_changed(int);
    callback time_changed(int);
    callback category_changed(int);
    callback sublayer_changed(int);
    callback predictions_model_changed(int);
    callback time_slider_changed(float);
    callback refresh_now();
    callback open_zoom();

    // Styling
    background: #101010;
    border-radius: 0px;

    VerticalLayout {
        width: 100%;
        height: 100%;
        spacing: 8px;
        padding-left: 16px;
        padding-right: 16px;
        padding-top: 10px;
        padding-bottom: 10px;

        // Top bar
        HorizontalLayout {
            width: 100%;
            height: 40px;
            spacing: 12px;

            Text {
                text: "Precipitation Intelligence";
                color: #ffffff;
                font-size: 22px;
                font-weight: 700;
                horizontal-alignment: left;
                vertical-alignment: center;
            }

            VerticalLayout {
                spacing: 2px;
                Text {
                    text: active_model_label + " • " + active_layer_label;
                    color: #a0a0a0;
                    font-size: 11px;
                    horizontal-alignment: left;
                }
                Text {
                    text: last_update_text;
                    color: #707070;
                    font-size: 9px;
                    horizontal-alignment: left;
                }
            }

            Rectangle { // spacer
                horizontal-stretch: 1;
                background: transparent;
            }

            // Refresh button (no icon dependency to avoid Icons.* mismatch)
            Button {
                text: "Refresh";
                clicked => { refresh_now(); }
            }

            Button {
                text: "Back to Overview";
                clicked => { go_back(); }
            }
        }

        // Upper control strip
        VerticalLayout {
            width: 100%;
            spacing: 6px;

            // Mode tabs
            HorizontalLayout {
                spacing: 6px;

                // Radar (Live)
                Rectangle {
                    background: selected_mode_index == 0 ? #2f7fff : #202020;
                    border-radius: 6px;
                    height: 24px;
                    width: 120px;

                    TouchArea {
                        clicked => { model_changed(0); }
                    }

                    Text {
                        text: "Radar (Live)";
                        color: #ffffff;
                        font-size: 11px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                // Predictions
                Rectangle {
                    background: selected_mode_index == 1 ? #2f7fff : #202020;
                    border-radius: 6px;
                    height: 24px;
                    width: 120px;

                    TouchArea {
                        clicked => { model_changed(1); }
                    }

                    Text {
                        text: "Predictions";
                        color: #ffffff;
                        font-size: 11px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }

            // Category selector and layer dropdown (for Predictions mode)
            if (selected_mode_index == 1) : HorizontalLayout {
                spacing: 8px;

                // Category tabs
                HorizontalLayout {
                    spacing: 4px;

                    // Precipitation Type
                    Rectangle {
                        background: selected_category_index == 0 ? #404040 : #181818;
                        border-radius: 5px;
                        height: 22px;
                        padding-left: 8px;
                        padding-right: 8px;

                        TouchArea {
                            clicked => { category_changed(0); }
                        }

                        Text {
                            text: "Type";
                            color: #ffffff;
                            font-size: 9px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Precipitation Probability
                    Rectangle {
                        background: selected_category_index == 1 ? #404040 : #181818;
                        border-radius: 5px;
                        height: 22px;
                        padding-left: 8px;
                        padding-right: 8px;

                        TouchArea {
                            clicked => { category_changed(1); }
                        }

                        Text {
                            text: "Probability";
                            color: #ffffff;
                            font-size: 9px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Precipitation Amount
                    Rectangle {
                        background: selected_category_index == 2 ? #404040 : #181818;
                        border-radius: 5px;
                        height: 22px;
                        padding-left: 8px;
                        padding-right: 8px;

                        TouchArea {
                            clicked => { category_changed(2); }
                        }

                        Text {
                            text: "Amount";
                            color: #ffffff;
                            font-size: 9px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Temperature
                    Rectangle {
                        background: selected_category_index == 3 ? #404040 : #181818;
                        border-radius: 5px;
                        height: 22px;
                        padding-left: 8px;
                        padding-right: 8px;

                        TouchArea {
                            clicked => { category_changed(3); }
                        }

                        Text {
                            text: "Temperature";
                            color: #ffffff;
                            font-size: 9px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Snow
                    Rectangle {
                        background: selected_category_index == 4 ? #404040 : #181818;
                        border-radius: 5px;
                        height: 22px;
                        padding-left: 8px;
                        padding-right: 8px;

                        TouchArea {
                            clicked => { category_changed(4); }
                        }

                        Text {
                            text: "Snow";
                            color: #ffffff;
                            font-size: 9px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Visibility
                    Rectangle {
                        background: selected_category_index == 5 ? #404040 : #181818;
                        border-radius: 5px;
                        height: 22px;
                        padding-left: 8px;
                        padding-right: 8px;

                        TouchArea {
                            clicked => { category_changed(5); }
                        }

                        Text {
                            text: "Visibility";
                            color: #ffffff;
                            font-size: 9px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Intensity
                    Rectangle {
                        background: selected_category_index == 6 ? #404040 : #181818;
                        border-radius: 5px;
                        height: 22px;
                        padding-left: 8px;
                        padding-right: 8px;

                        TouchArea {
                            clicked => { category_changed(6); }
                        }

                        Text {
                            text: "Intensity";
                            color: #ffffff;
                            font-size: 9px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }

                // Layer dropdown
                DropDownMenu {
                    label: "Select Layer";
                    items: layer_dropdown_items;
                    current_index: selected_sublayer_index;
                    width: 300px;
                    selected(index) => { sublayer_changed(index); }
                }

                // Model selector (for Predictions mode)
                if (selected_mode_index == 1) : DropDownMenu {
                    label: "Model";
                    items: model_dropdown_items;
                    current_index: selected_predictions_model_index;
                    width: 150px;
                    height: 50px;
                    selected(index) => { predictions_model_changed(index); }
                }
            }

            // Overlay toggles + time controls
            HorizontalLayout {
                spacing: 10px;

                // When Radar is selected, show Rain/Snow toggle instead of model layer toggles.
                if (selected_mode_index == 0) : Rectangle {
                    background: #181818;
                    border-radius: 10px;
                    height: 18px;
                    padding-left: 8px;
                    padding-right: 8px;

                    HorizontalLayout {
                        spacing: 4px;
                        Text {
                            text: "Radar:";
                            color: #ffffff;
                            font-size: 8px;
                            vertical-alignment: center;
                        }

                        Rectangle {
                            background: selected_layer_index == 6 ? #2f7fff : #303030;
                            border-radius: 8px;
                            padding-left: 6px;
                            padding-right: 6px;
                            height: 14px;

                            Text {
                                text: "Rain";
                                color: #ffffff;
                                font-size: 8px;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }

                            TouchArea {
                                clicked => { layer_changed(6); }
                            }
                        }

                        Rectangle {
                            background: selected_layer_index == 7 ? #2f7fff : #303030;
                            border-radius: 8px;
                            padding-left: 6px;
                            padding-right: 6px;
                            height: 14px;

                            Text {
                                text: "Snow";
                                color: #ffffff;
                                font-size: 8px;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }

                            TouchArea {
                                clicked => { layer_changed(7); }
                            }
                        }
                    }
                }


                HorizontalLayout {
                    height: 50px;

                    Rectangle { horizontal-stretch: 1; background: transparent; }

                    // Time controls: prev / label / next
                    IconButton {
                        icon: Icons.chevron_backward;
                        tooltip: "Previous time step";
                        clicked => { time_changed(selected_time_index - 1); }
                    }

                    Text {
                        text: active_time_label;
                        color: #ffffff;
                        font-size: 9px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        width: 80px;
                    }

                    IconButton {
                        icon: Icons.chevron_forward;
                        tooltip: "Next time step";
                        clicked => { time_changed(selected_time_index + 1); }
                    }

                    // Time slider for predictions
                    if (selected_mode_index == 1) : Slider {
                        value: time_slider_value;
                        minimum: time_slider_min;
                        maximum: time_slider_max;
                        value_changed(value) => { time_slider_changed(value); }
                        width: 150px;
                    }
                }
            }
        }

        // Main content: map + right-hand context
        HorizontalLayout {
            width: 100%;
            spacing: 8px;

            // Map area
            Rectangle {
                horizontal-stretch: 1;
                background: #1c1c1c;
                border-radius: 8px;
                clip: true;

                Text {
                    text: "Click on Radar or Predictions to start";
                    color: #d1d1d1;
                    font-size: 20px;
                }

                // Base map
                if (!loading && error_message == "") : Image {
                    source: base_map_image;
                    y: -10px;
                    width: 100%;
                    height: 100%;
                    image-fit: contain;
                }

                // Dark overlay to match aesthetic
                Rectangle {
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.35);
                }

                // Active precip layer
                if (!loading && error_message == "") : Image {
                    source: active_precip_image;
                    width: 100%;
                    height: 100%;
                    image-fit: contain;
                    opacity: 70%;
                }

                // Error overlay when image decoding fails
                if (active_image_error) : Rectangle {
                    width: 100%;
                    height: 100%;
                    background: #000000;

                    Text {
                        text: "TIME UNAVAILABLE";
                        color: #ffffff;
                        font-size: 24px;
                        font-weight: 700;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }



                // Loading / error overlays
                if (loading) : Text {
                    text: "Loading precipitation data...";
                    color: #ffffff;
                    font-size: 14px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                if (!loading && error_message != "") : Text {
                    text: error_message;
                    color: #ff5555;
                    font-size: 12px;
                    wrap: word-wrap;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    padding-left: 16px;
                    padding-right: 16px;
                }

                // Legend in bottom-right
                if (!loading && error_message == "") : Image {
                    source: legend_image;
                    width: parent.width * 0.4;
                    height: parent.height * 0.4;
                    x: 670px;
                    y: 0px;
                    image-fit: contain;
                    opacity: 0.95;
                }

                // Touch to open zoom overlay (handled in MainWindow)
                TouchArea {
                    clicked => {
                        if (!loading && error_message == "") {
                            open_zoom();
                        }
                    }
                }
            }

            // Right-side metrics/context column
            // TODO IMPLEMENT POINT DATA
            if(false) : VerticalLayout {
                width: 260px;
                spacing: 8px;

                // Probabilities card
                Rectangle {
                    background: #181818;
                    border-radius: 8px;
                    height: 90px;
                    padding-left: 8px;
                    padding-right: 8px;
                    padding-top: 6px;
                    padding-bottom: 6px;

                    VerticalLayout {
                        spacing: 2px;

                        Text {
                            text: "Precipitation probabilities";
                            color: #ffffff;
                            font-size: 10px;
                            font-weight: 600;
                        }

                        // Inline rows (no nested function for compatibility)
                        HorizontalLayout {
                            spacing: 4px;
                            Text {
                                text: "Any precip";
                                color: #c0c0c0;
                                font-size: 8px;
                                width: 80px;
                            }
                            Rectangle {
                                horizontal-stretch: 1;
                                height: 6px;
                                border-radius: 3px;
                                background: #202020;

                                Rectangle {
                                    width: parent.width * prob_any_precip / 100;
                                    height: 100%;
                                    border-radius: 3px;
                                    background: #2f7fff;
                                }
                            }
                            Text {
                                text: prob_any_precip + "%";
                                color: #ffffff;
                                font-size: 8px;
                                width: 26px;
                                horizontal-alignment: right;
                            }
                        }

                        HorizontalLayout {
                            spacing: 4px;
                            Text {
                                text: "Rain";
                                color: #c0c0c0;
                                font-size: 8px;
                                width: 80px;
                            }
                            Rectangle {
                                horizontal-stretch: 1;
                                height: 6px;
                                border-radius: 3px;
                                background: #202020;

                                Rectangle {
                                    width: parent.width * prob_rain / 100;
                                    height: 100%;
                                    border-radius: 3px;
                                    background: #3a8f3a;
                                }
                            }
                            Text {
                                text: prob_rain + "%";
                                color: #ffffff;
                                font-size: 8px;
                                width: 26px;
                                horizontal-alignment: right;
                            }
                        }

                        HorizontalLayout {
                            spacing: 4px;
                            Text {
                                text: "Snow";
                                color: #c0c0c0;
                                font-size: 8px;
                                width: 80px;
                            }
                            Rectangle {
                                horizontal-stretch: 1;
                                height: 6px;
                                border-radius: 3px;
                                background: #202020;

                                Rectangle {
                                    width: parent.width * prob_snow / 100;
                                    height: 100%;
                                    border-radius: 3px;
                                    background: #3a8f3a;
                                }
                            }
                            Text {
                                text: prob_snow + "%";
                                color: #ffffff;
                                font-size: 8px;
                                width: 26px;
                                horizontal-alignment: right;
                            }
                        }
                    }
                }

                // Freezing/mixed & QPF card
                Rectangle {
                    background: #181818;
                    border-radius: 8px;
                    height: 80px;
                    padding-left: 8px;
                    padding-right: 8px;
                    padding-top: 6px;
                    padding-bottom: 6px;

                    VerticalLayout {
                        spacing: 2px;

                        Text {
                            text: "Freezing / Mixed & amounts";
                            color: #ffffff;
                            font-size: 10px;
                            font-weight: 600;
                        }

                        HorizontalLayout {
                            spacing: 6px;
                            Text {
                                text: "Frzg rain " + prob_freezing_rain + "%";
                                color: #ffaaaa;
                                font-size: 8px;
                            }
                            Text {
                                text: "Ice pellets " + prob_ice_pellets + "%";
                                color: #ffdd88;
                                font-size: 8px;
                            }
                        }

                        HorizontalLayout {
                            spacing: 6px;
                            Text {
                                text: "Next 6h: " + qpf_6h + " mm";
                                color: #a0a0ff;
                                font-size: 8px;
                            }
                            Text {
                                text: "12h: " + qpf_12h + " mm";
                                color: #a0a0ff;
                                font-size: 8px;
                            }
                            Text {
                                text: "24h: " + qpf_24h + " mm";
                                color: #a0a0ff;
                                font-size: 8px;
                            }
                        }
                    }
                }

                // Snow depth / temp / pressure
                Rectangle {
                    background: #181818;
                    border-radius: 8px;
                    height: 70px;
                    padding-left: 8px;
                    padding-right: 8px;
                    padding-top: 6px;
                    padding-bottom: 6px;

                    VerticalLayout {
                        spacing: 2px;

                        Text {
                            text: "Snow / Temperature / Pressure";
                            color: #ffffff;
                            font-size: 10px;
                            font-weight: 600;
                        }

                        HorizontalLayout {
                            spacing: 6px;
                            Text {
                                text: "Snow depth: " + snow_depth + " cm";
                                color: #c0e0ff;
                                font-size: 8px;
                            }
                        }

                        HorizontalLayout {
                            spacing: 6px;
                            Text {
                                text: "Temp: " + air_temp + " °C";
                                color: #ff9999;
                                font-size: 8px;
                            }
                            Text {
                                text: "Dewpt: " + dewpoint + " °C";
                                color: #99ddff;
                                font-size: 8px;
                            }
                            Text {
                                text: "P: " + pressure + " hPa";
                                color: #dddddd;
                                font-size: 8px;
                            }
                        }
                    }
                }

                // Systems / context
                Rectangle {
                    background: #181818;
                    border-radius: 8px;
                    horizontal-stretch: 1;
                    padding-left: 8px;
                    padding-right: 8px;
                    padding-top: 6px;
                    padding-bottom: 6px;

                    VerticalLayout {
                        spacing: 4px;

                        Text {
                            text: "Synoptic context";
                            color: #ffffff;
                            font-size: 10px;
                            font-weight: 600;
                        }

                        Text {
                            text: system_summary;
                            color: #b0b0b0;
                            font-size: 8px;
                            wrap: word-wrap;
                            horizontal-alignment: left;
                            vertical-alignment: top;
                        }
                    }
                }
            }
        }

        // Bottom strip: run info, model selector, and status
        HorizontalLayout {
            width: 100%;
            height: 22px;
            spacing: 14px;

            Text {
                text: "Model runs: " + last_update_text;
                color: #707070;
                font-size: 8px;
                horizontal-alignment: left;
            }

            Rectangle { horizontal-stretch: 1; background: transparent; }

            if (error_message != "") : Text {
                text: "Status: " + error_message;
                color: #ff5555;
                font-size: 8px;
                horizontal-alignment: right;
            }

            if (error_message == "" && !loading) : Text {
                text: "Status: Precipitation page online";
                color: #3fbf7f;
                font-size: 8px;
                horizontal-alignment: right;
            }

            if (loading) : Text {
                text: "Status: Updating...";
                color: #ffaa33;
                font-size: 8px;
                horizontal-alignment: right;
            }
        }
    }
}
